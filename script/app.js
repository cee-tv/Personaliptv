const channels = {
    tv5hd: {
        name: "TV5 HD",
        url: "https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/tv5_hd.mpd",
        number: 1,
        drmConfig: {
            clearKeys: {
                '2615129ef2c846a9bbd43a641c7303ef': '07c7f996b1734ea288641a68e1cfdc4d'
    },
    rptvhd: {
        name: "RPTV HD",
        url: "https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cnn_rptv_prod_hd.mpd",
        number: 2,
        drmConfig: {
            clearKeys: {
                '1917f4caf2364e6d9b1507326a85ead6': 'a1340a251a5aa63a9b0ea5d9d7f67595' 
    },
    trthaber: {
        name: "TRT Haber",
        url: "https://tv-trthaber.medya.trt.com.tr/master.m3u8",
        number: 3,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtspor: {
        name: "TRT Spor",
        url: "https://tv-trtspor1.medya.trt.com.tr/master.m3u8",
        number: 4,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtbelgesel: {
        name: "TRT Belgesel",
        url: "https://tv-trtbelgesel.medya.trt.com.tr/master.m3u8",
        number: 5,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtcocuk: {
        name: "TRT Çocuk",
        url: "https://tv-trtcocuk.medya.trt.com.tr/master.m3u8",
        number: 6,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    showtv: {
        name: "Show TV",
        url: "https://ciner-live.daioncdn.net/showtv/showtv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    startv: {
        name: "Star TV",
        url: "https://dogus-live.daioncdn.net/startv/startv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    tv8: {
        name: "TV8",
        url: "https://tv8-live.daioncdn.net/tv8/tv8.m3u8",
        number: 8,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    beyaztv: {
        name: "Beyaz TV",
        url: "https://beyaztv-live.daioncdn.net/beyaztv/beyaztv.m3u8",
        number: 9,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    ntv: {
        name: "NTV",
        url: "https://dogus-live.daioncdn.net/ntv/ntv.m3u8",
        number: 10,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt2: {
        name: "TRT 2",
        url: "https://tv-trt2.medya.trt.com.tr/master.m3u8",
        number: 11,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    numberone: {
        name: "Number One",
        url: "https://b01c02nl.mediatriple.net/videoonlylive/mtkgeuihrlfwlive/broadcast_5c9e17cd59e8b.smil/playlist.m3u8",
        number: 13,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    haberturk: {
        name: "Habertürk",
        url: "https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8",
        number: 12,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt1: {
        name: "TRT 1",
        url: "https://tv-trt1.medya.trt.com.tr/master.m3u8",
        number: 1,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb'
    },
    trtmuzik: {
        name: "TRT Müzik",
        url: "https://tv-trtmuzik.medya.trt.com.tr/master.m3u8",
        number: 14,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trthaber: {
        name: "TRT Haber",
        url: "https://tv-trthaber.medya.trt.com.tr/master.m3u8",
        number: 2,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtspor: {
        name: "TRT Spor",
        url: "https://tv-trtspor1.medya.trt.com.tr/master.m3u8",
        number: 3,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtbelgesel: {
        name: "TRT Belgesel",
        url: "https://tv-trtbelgesel.medya.trt.com.tr/master.m3u8",
        number: 4,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtcocuk: {
        name: "TRT Çocuk",
        url: "https://tv-trtcocuk.medya.trt.com.tr/master.m3u8",
        number: 5,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    showtv: {
        name: "Show TV",
        url: "https://ciner-live.daioncdn.net/showtv/showtv.m3u8",
        number: 6,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    startv: {
        name: "Star TV",
        url: "https://dogus-live.daioncdn.net/startv/startv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    tv8: {
        name: "TV8",
        url: "https://tv8-live.daioncdn.net/tv8/tv8.m3u8",
        number: 8,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    beyaztv: {
        name: "Beyaz TV",
        url: "https://beyaztv-live.daioncdn.net/beyaztv/beyaztv.m3u8",
        number: 9,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    ntv: {
        name: "NTV",
        url: "https://dogus-live.daioncdn.net/ntv/ntv.m3u8",
        number: 10,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt2: {
        name: "TRT 2",
        url: "https://tv-trt2.medya.trt.com.tr/master.m3u8",
        number: 11,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    numberone: {
        name: "Number One",
        url: "https://b01c02nl.mediatriple.net/videoonlylive/mtkgeuihrlfwlive/broadcast_5c9e17cd59e8b.smil/playlist.m3u8",
        number: 13,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    haberturk: {
        name: "Habertürk",
        url: "https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8",
        number: 12,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt1: {
        name: "TRT 1",
        url: "https://tv-trt1.medya.trt.com.tr/master.m3u8",
        number: 1,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb'
    },
    trtmuzik: {
        name: "TRT Müzik",
        url: "https://tv-trtmuzik.medya.trt.com.tr/master.m3u8",
        number: 14,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trthaber: {
        name: "TRT Haber",
        url: "https://tv-trthaber.medya.trt.com.tr/master.m3u8",
        number: 2,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtspor: {
        name: "TRT Spor",
        url: "https://tv-trtspor1.medya.trt.com.tr/master.m3u8",
        number: 3,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtbelgesel: {
        name: "TRT Belgesel",
        url: "https://tv-trtbelgesel.medya.trt.com.tr/master.m3u8",
        number: 4,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtcocuk: {
        name: "TRT Çocuk",
        url: "https://tv-trtcocuk.medya.trt.com.tr/master.m3u8",
        number: 5,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    showtv: {
        name: "Show TV",
        url: "https://ciner-live.daioncdn.net/showtv/showtv.m3u8",
        number: 6,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    startv: {
        name: "Star TV",
        url: "https://dogus-live.daioncdn.net/startv/startv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    tv8: {
        name: "TV8",
        url: "https://tv8-live.daioncdn.net/tv8/tv8.m3u8",
        number: 8,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    beyaztv: {
        name: "Beyaz TV",
        url: "https://beyaztv-live.daioncdn.net/beyaztv/beyaztv.m3u8",
        number: 9,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    ntv: {
        name: "NTV",
        url: "https://dogus-live.daioncdn.net/ntv/ntv.m3u8",
        number: 10,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt2: {
        name: "TRT 2",
        url: "https://tv-trt2.medya.trt.com.tr/master.m3u8",
        number: 11,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    numberone: {
        name: "Number One",
        url: "https://b01c02nl.mediatriple.net/videoonlylive/mtkgeuihrlfwlive/broadcast_5c9e17cd59e8b.smil/playlist.m3u8",
        number: 13,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    haberturk: {
        name: "Habertürk",
        url: "https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8",
        number: 12,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt1: {
        name: "TRT 1",
        url: "https://tv-trt1.medya.trt.com.tr/master.m3u8",
        number: 1,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb'
    },
    trtmuzik: {
        name: "TRT Müzik",
        url: "https://tv-trtmuzik.medya.trt.com.tr/master.m3u8",
        number: 14,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trthaber: {
        name: "TRT Haber",
        url: "https://tv-trthaber.medya.trt.com.tr/master.m3u8",
        number: 2,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtspor: {
        name: "TRT Spor",
        url: "https://tv-trtspor1.medya.trt.com.tr/master.m3u8",
        number: 3,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtbelgesel: {
        name: "TRT Belgesel",
        url: "https://tv-trtbelgesel.medya.trt.com.tr/master.m3u8",
        number: 4,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtcocuk: {
        name: "TRT Çocuk",
        url: "https://tv-trtcocuk.medya.trt.com.tr/master.m3u8",
        number: 5,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    showtv: {
        name: "Show TV",
        url: "https://ciner-live.daioncdn.net/showtv/showtv.m3u8",
        number: 6,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    startv: {
        name: "Star TV",
        url: "https://dogus-live.daioncdn.net/startv/startv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    tv8: {
        name: "TV8",
        url: "https://tv8-live.daioncdn.net/tv8/tv8.m3u8",
        number: 8,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    beyaztv: {
        name: "Beyaz TV",
        url: "https://beyaztv-live.daioncdn.net/beyaztv/beyaztv.m3u8",
        number: 9,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    ntv: {
        name: "NTV",
        url: "https://dogus-live.daioncdn.net/ntv/ntv.m3u8",
        number: 10,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt2: {
        name: "TRT 2",
        url: "https://tv-trt2.medya.trt.com.tr/master.m3u8",
        number: 11,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    numberone: {
        name: "Number One",
        url: "https://b01c02nl.mediatriple.net/videoonlylive/mtkgeuihrlfwlive/broadcast_5c9e17cd59e8b.smil/playlist.m3u8",
        number: 13,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    haberturk: {
        name: "Habertürk",
        url: "https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8",
        number: 12,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt1: {
        name: "TRT 1",
        url: "https://tv-trt1.medya.trt.com.tr/master.m3u8",
        number: 1,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb'
    },
    trtmuzik: {
        name: "TRT Müzik",
        url: "https://tv-trtmuzik.medya.trt.com.tr/master.m3u8",
        number: 14,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trthaber: {
        name: "TRT Haber",
        url: "https://tv-trthaber.medya.trt.com.tr/master.m3u8",
        number: 2,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtspor: {
        name: "TRT Spor",
        url: "https://tv-trtspor1.medya.trt.com.tr/master.m3u8",
        number: 3,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtbelgesel: {
        name: "TRT Belgesel",
        url: "https://tv-trtbelgesel.medya.trt.com.tr/master.m3u8",
        number: 4,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trtcocuk: {
        name: "TRT Çocuk",
        url: "https://tv-trtcocuk.medya.trt.com.tr/master.m3u8",
        number: 5,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    showtv: {
        name: "Show TV",
        url: "https://ciner-live.daioncdn.net/showtv/showtv.m3u8",
        number: 6,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    startv: {
        name: "Star TV",
        url: "https://dogus-live.daioncdn.net/startv/startv.m3u8",
        number: 7,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    tv8: {
        name: "TV8",
        url: "https://tv8-live.daioncdn.net/tv8/tv8.m3u8",
        number: 8,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    beyaztv: {
        name: "Beyaz TV",
        url: "https://beyaztv-live.daioncdn.net/beyaztv/beyaztv.m3u8",
        number: 9,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    ntv: {
        name: "NTV",
        url: "https://dogus-live.daioncdn.net/ntv/ntv.m3u8",
        number: 10,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    trt2: {
        name: "TRT 2",
        url: "https://tv-trt2.medya.trt.com.tr/master.m3u8",
        number: 11,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    numberone: {
        name: "Number One",
        url: "https://b01c02nl.mediatriple.net/videoonlylive/mtkgeuihrlfwlive/broadcast_5c9e17cd59e8b.smil/playlist.m3u8",
        number: 13,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    haberturk: {
        name: "Habertürk",
        url: "https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8",
        number: 12,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb' 
    },
    viva: {
        name: "Viva",
        url: "https://qp-pldt-live-grp-06-prod.akamaized.net/out/u/viva_sd.mpd",
        number: 15,
        drmConfig: {
            clearKeys: {
                '07aa813bf2c147748046edd930f7736e': '3bd6688b8b44e96201e753224adfc8fb'
            }
        }
    }
};

let shakaPlayer = null;
let isPoweredOn = true;
let currentVolume = 1;
let channelInputTimeout = null;
let currentChannelInput = "";
let currentChannelIndex = 0;
let retryCount = 0;
const MAX_RETRIES = 3;
const RETRY_DELAY = 2000; // 2 seconds

// Initialize Shaka Player
function initApp() {
    shaka.polyfill.installAll();
    
    if (shaka.Player.isBrowserSupported()) {
        initPlayer();
    } else {
        console.error('Browser not supported!');
    }
}

function initPlayer() {
    const video = document.getElementById('video-player');
    shakaPlayer = new shaka.Player(video);

    shakaPlayer.addEventListener('error', onErrorEvent);
    
    // Configure for low latency streaming
    shakaPlayer.configure({
        streaming: {
            bufferingGoal: 10,
            rebufferingGoal: 2,
            bufferBehind: 30
        }
    });
}

function onErrorEvent(event) {
    // Handle both event object and direct error cases
    const error = event.detail || event;
    console.error('Error:', error);
    retryPlayback();
}

function retryPlayback() {
    if (retryCount < MAX_RETRIES) {
        retryCount++;
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = `Connection error. Retrying... (${retryCount}/${MAX_RETRIES})`;
        errorMessage.style.display = 'block';
        
        setTimeout(() => {
            const currentChannelId = Object.keys(channels)[currentChannelIndex];
            loadChannel(currentChannelId);
        }, RETRY_DELAY);
    } else {
        handlePlaybackError();
        retryCount = 0;
    }
}

// Add new helper function to handle channel loading
function loadChannel(channelId) {
    const channel = channels[channelId];
    try {
        if (shakaPlayer) {
            shakaPlayer.unload();
            
            if (channel.drmConfig) {
                shakaPlayer.configure({
                    drm: {
                        clearKeys: channel.drmConfig.clearKeys
                    }
                });
            }
            
            shakaPlayer.load(channel.url)
                .then(() => {
                    const video = document.getElementById('video-player');
                    video.volume = currentVolume;
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Autoplay prevented:", error);
                            // Show play button or handle autoplay prevention
                        });
                    }
                    document.getElementById('error-message').style.display = 'none';
                    retryCount = 0;
                })
                .catch((error) => {
                    console.error('Load error:', error);
                    onErrorEvent(error);
                });
        }
    } catch (error) {
        console.error('Load channel error:', error);
        onErrorEvent(error);
    }
}

function handlePlaybackError() {
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = 'Channel failed to load. Please try another channel.';
    errorMessage.style.display = 'block';
    setTimeout(() => {
        errorMessage.style.display = 'none';
    }, 5000);
}

// Update changeChannel function to use loadChannel
function changeChannel(channelId) {
    if (!isPoweredOn) return;
    
    currentChannelIndex = Object.keys(channels).indexOf(channelId);
    
    const video = document.getElementById('video-player');
    const channelInfo = document.getElementById('channel-info');
    const errorMessage = document.getElementById('error-message');
    const channel = channels[channelId];
    
    errorMessage.style.display = 'none';
    channelInfo.textContent = `${channel.number}. ${channel.name}`;
    channelInfo.style.display = 'block';
    document.title = `${channel.name} - Türk TV`;
    
    video.style.display = 'block';
    
    loadChannel(channelId);
    
    setTimeout(() => {
        channelInfo.style.display = 'none';
    }, 3000);
}

// Initialize when document is loaded
document.addEventListener('DOMContentLoaded', () => {
    initApp();
    // Add a small delay to ensure Shaka Player is fully initialized
    setTimeout(() => {
        const video = document.getElementById('video-player');
        video.volume = currentVolume;
        changeChannel('trt1');
        // Add click event listener for mobile devices
        video.addEventListener('click', () => {
            if (video.paused) {
                video.play();
            }
        });
    }, 1000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (shakaPlayer) {
        shakaPlayer.destroy();
    }
});

function showVolumeIndicator(volume) {
    const indicator = document.getElementById('volume-indicator');
    indicator.textContent = `Volume: ${Math.round(volume * 100)}%`;
    indicator.style.display = 'block';
    
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 2000);
}

function adjustVolume(change) {
    if (!isPoweredOn) return;
    
    const video = document.getElementById('video-player');
    currentVolume = Math.max(0, Math.min(1, currentVolume + change));
    video.volume = currentVolume;
    showVolumeIndicator(currentVolume);
}

function inputChannel(number) {
    if (!isPoweredOn) return;
    
    currentChannelInput += number;
    
    const channelInput = document.getElementById('channel-input');
    channelInput.textContent = currentChannelInput;
    channelInput.style.display = 'block';
    
    if (channelInputTimeout) {
        clearTimeout(channelInputTimeout);
    }
    
    channelInputTimeout = setTimeout(() => {
        channelInput.style.display = 'none';
        
        const channelEntry = Object.entries(channels).find(([_, channel]) => 
            channel.number === parseInt(currentChannelInput)
        );
        
        if (channelEntry) {
            changeChannel(channelEntry[0]);
        }
        
        currentChannelInput = "";
    }, 1000);
}

function togglePower() {
    const screen = document.getElementById('tv-screen');
    const video = document.getElementById('video-player');
    const powerBtn = document.querySelector('.remote-power');
    
    isPoweredOn = !isPoweredOn;
    
    if (!isPoweredOn) {
        screen.classList.add('off');
        powerBtn.classList.add('off');
        
        if (shakaPlayer) {
            shakaPlayer.unload();
        }
        video.style.display = 'none';
    } else {
        screen.classList.remove('off');
        powerBtn.classList.remove('off');
        video.style.display = 'block';
        setTimeout(() => changeChannel('trt1'), 100); // Auto play TRT 1 when powered on
    }
}

function changeChannelRelative(direction) {
    if (!isPoweredOn) return;
    
    // Get current channel number
    const currentChannel = Object.values(channels).find((channel, index) => index === currentChannelIndex);
    let nextChannelNumber = currentChannel.number + direction;
    
    // Handle wraparound
    if (nextChannelNumber < 1) nextChannelNumber = 15;
    if (nextChannelNumber > 15) nextChannelNumber = 1;
    
    // Find channel by number
    const nextChannel = Object.entries(channels).find(([_, channel]) => 
        channel.number === nextChannelNumber
    );
    
    if (nextChannel) {
        changeChannel(nextChannel[0]);
    }
}

document.addEventListener('keydown', (e) => {
    if (!isPoweredOn && e.key !== 'p') return;
    
    switch(e.key.toLowerCase()) {
        case 'p':
            togglePower();
            break;
        case 'arrowup':
            changeChannelRelative(1);
            break;
        case 'arrowdown':
            changeChannelRelative(-1);
            break;
        case 'arrowleft':
            adjustVolume(-0.1);
            break;
        case 'arrowright':
            adjustVolume(0.1);
            break;
        case 'm':
            toggleMute();
            break;
        case 'l':
            toggleInterface('channels');
            break;
        case 'r':
            toggleInterface('remote');
            break;
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
            inputChannel(parseInt(e.key));
            break;
    }
});

let isMuted = false;
let previousVolume = 1;

function toggleMute() {
    if (!isPoweredOn) return;
    
    const video = document.getElementById('video-player');
    if (isMuted) {
        video.volume = previousVolume;
        currentVolume = previousVolume;
        isMuted = false;
        showVolumeIndicator(currentVolume);
    } else {
        previousVolume = currentVolume;
        video.volume = 0;
        currentVolume = 0;
        isMuted = true;
        showVolumeIndicator(0);
    }
}

document.getElementById('toggle-menu').addEventListener('click', function() {
    const menuOverlay = document.getElementById('menu-overlay');
    menuOverlay.style.display = menuOverlay.style.display === 'none' ? 'block' : 'none';
});

function toggleInterface(type) {
    const channelList = document.getElementById('channel-list');
    const remoteControl = document.getElementById('remote-container');
    const menuOverlay = document.getElementById('menu-overlay');
    const keyboardOverlay = document.getElementById('keyboard-overlay');

    // Hide menu overlay
    menuOverlay.style.display = 'none';

    // Hide all interfaces first
    channelList.classList.remove('visible');
    channelList.style.display = 'none';
    remoteControl.classList.add('hidden');
    keyboardOverlay.style.display = 'none';

    // Show the requested interface
    switch(type) {
        case 'remote':
            remoteControl.classList.remove('hidden');
            break;
        case 'channels':
            channelList.style.display = 'block';
            setTimeout(() => channelList.classList.add('visible'), 10);
            break;
        case 'keyboard':
            keyboardOverlay.style.display = 'block';
            break;
    }
}

function hideInterface(type) {
    const channelList = document.getElementById('channel-list');
    const remoteControl = document.getElementById('remote-container');
    const keyboardOverlay = document.getElementById('keyboard-overlay');

    switch(type) {
        case 'remote':
            remoteControl.classList.add('hidden');
            break;
        case 'channels':
            channelList.classList.remove('visible');
            setTimeout(() => {
                channelList.style.display = 'none';
            }, 300);
            break;
        case 'keyboard':
            keyboardOverlay.style.display = 'none';
            break;
    }
}

// Update click event listener to include keyboard overlay
document.addEventListener('click', function(event) {
    const channelList = document.getElementById('channel-list');
    const remoteControl = document.getElementById('remote-container');
    const menuOverlay = document.getElementById('menu-overlay');
    const keyboardOverlay = document.getElementById('keyboard-overlay');
    const toggleMenuBtn = document.getElementById('toggle-menu');

    if (channelList.style.display !== 'none' && 
        !channelList.contains(event.target) && 
        !toggleMenuBtn.contains(event.target)) {
        hideInterface('channels');
    }

    if (!remoteControl.classList.contains('hidden') && 
        !remoteControl.contains(event.target) && 
        !toggleMenuBtn.contains(event.target)) {
        hideInterface('remote');
    }

    if (menuOverlay.style.display !== 'none' && 
        !menuOverlay.contains(event.target) && 
        !toggleMenuBtn.contains(event.target)) {
        menuOverlay.style.display = 'none';
    }

    if (keyboardOverlay.style.display !== 'none' && 
        !keyboardOverlay.contains(event.target) && 
        !toggleMenuBtn.contains(event.target)) {
        hideInterface('keyboard');
    }
});

// Add click stop propagation for keyboard overlay
document.getElementById('keyboard-overlay').addEventListener('click', function(event) {
    event.stopPropagation();
});

// Prevent clicks inside elements from bubbling up and triggering the hide
document.getElementById('channel-list').addEventListener('click', function(event) {
    event.stopPropagation();
});

document.getElementById('remote-container').addEventListener('click', function(event) {
    event.stopPropagation();
});

document.getElementById('menu-overlay').addEventListener('click', function(event) {
    event.stopPropagation();
});

// Add network status monitoring
window.addEventListener('online', () => {
    if (isPoweredOn) {
        const currentChannelId = Object.keys(channels)[currentChannelIndex];
        changeChannel(currentChannelId); // Retry current channel when connection is restored
    }
});
